<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/layout"
	layout:decorate="layout/layout">

<head>
<!-- CSS pour FullCalendar -->
<link
	href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css'
	rel='stylesheet' />
<link rel="stylesheet"
	href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link th:href="@{/ressources/css/taches.css}" rel='stylesheet'/>
</head>

<div layout:fragment="content">
	<div
		class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
		<h1 class="h2">Gestion des Tâches</h1>
		<div class="btn-toolbar mb-2 mb-md-0">
			<button class="btn btn-primary" data-bs-toggle="modal"
				data-bs-target="#addTaskModal">
				<i class="fas fa-plus me-1"></i>Nouvelle Tâche
			</button>
		</div>
	</div>

	<!-- Alertes et Messages -->
	<div th:if="${param.success}"
		class="alert alert-success alert-dismissible fade show">
		<span th:text="${param.success}">Tâche créée avec succès!</span>
		<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	</div>

	<!-- Barre d'outils d'export -->
	<div class="btn-toolbar mb-3" role="toolbar">
		<div class="btn-group me-2">
			<button type="button" class="btn btn-outline-success" id="exportPdf">
				<i class="fas fa-file-pdf me-1"></i>PDF
			</button>
			<button type="button" class="btn btn-outline-success"
				id="exportExcel">
				<i class="fas fa-file-excel me-1"></i>Excel
			</button>
			<button type="button" class="btn btn-outline-success" id="exportCsv">
				<i class="fas fa-file-csv me-1"></i>CSV
			</button>
		</div>
		<div class="btn-group me-2">
			<button type="button" class="btn btn-outline-info"
				id="enableNotifications">
				<i class="fas fa-bell me-1"></i>Notifications
			</button>
		</div>
	</div>

	<!-- Filtres -->
	<div class="card mb-4">
		<div class="card-body">
			<div class="row g-3">
				<div class="col-md-3">
					<label class="form-label">Vue</label> <select class="form-select"
						id="viewSelect">
						<option value="kanban">Vue Kanban</option>
						<option value="list">Vue Liste</option>
						<option value="calendar">Vue Calendrier</option>
					</select>
				</div>
				<div class="col-md-2">
					<label class="form-label">Priorité</label> <select
						class="form-select" id="priorityFilter">
						<option value="">Toutes</option>
						<option value="URGENTE">Haute</option>
						<option value="HAUTE">Haute</option>
						<option value="NORMALE">Moyenne</option>
						<option value="BASSE">Basse</option>
					</select>
				</div>
				<div class="col-md-2">
					<label class="form-label">Statut</label> <select
						class="form-select" id="statusFilter">
						<option value="">Tous</option>
						<option value="A_FAIRE">À faire</option>
						<option value="EN_COURS">En cours</option>
						<option value="TERMINE">Terminé</option>
						<option value="ANNULE">Annulé</option>
					</select>
				</div>
				<div class="col-md-3">
					<label class="form-label">Date d'échéance</label> <input
						type="date" class="form-control" id="dateFilter">
				</div>
				<div class="col-md-2 d-flex align-items-end">
					<button class="btn btn-outline-secondary w-100" id="resetFilters">
						<i class="fas fa-refresh me-1"></i>Réinitialiser
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Vue Kanban -->
	<div id="kanbanView">
		<div class="row">
			<!-- Colonne À Faire -->
			<div class="col-lg-3 mb-4">
				<div class="card border-primary">
					<div
						class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
						<h6 class="mb-0">À Faire</h6>
						<span class="badge bg-light text-dark" id="a_faireCount">0</span>
					</div>
					<div class="card-body kanban-column" data-status="A_FAIRE"
						style="min-height: 500px;">
						<!-- Tâches dynamiques via JavaScript -->
					</div>
				</div>
			</div>

			<!-- Colonne En Cours -->
			<div class="col-lg-3 mb-4">
				<div class="card border-warning">
					<div
						class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
						<h6 class="mb-0">En Cours</h6>
						<span class="badge bg-light text-dark" id="en_coursCount">0</span>
					</div>
					<div class="card-body kanban-column" data-status="EN_COURS"
						style="min-height: 500px;">
						<!-- Tâches dynamiques via JavaScript -->
					</div>
				</div>
			</div>

			<!-- Colonne Terminé -->
			<div class="col-lg-3 mb-4">
				<div class="card border-success">
					<div
						class="card-header bg-success text-white d-flex justify-content-between align-items-center">
						<h6 class="mb-0">Terminé</h6>
						<span class="badge bg-light text-dark" id="termineCount">0</span>
					</div>
					<div class="card-body kanban-column" data-status="TERMINE"
						style="min-height: 500px;">
						<!-- Tâches dynamiques via JavaScript -->
					</div>
				</div>
			</div>

			<!-- Colonne Annulé -->
			<div class="col-lg-3 mb-4">
				<div class="card border-secondary">
					<div
						class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
						<h6 class="mb-0">Annulé</h6>
						<span class="badge bg-light text-dark" id="annuleCount">0</span>
					</div>
					<div class="card-body kanban-column" data-status="ANNULE"
						style="min-height: 500px;">
						<!-- Tâches dynamiques via JavaScript -->
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Vue Calendrier (cachée par défaut) -->
	<div id="calendarView" class="d-none">
		<div class="card">
			<div class="card-body">
				<div id="calendar"></div>
			</div>
		</div>
	</div>

	<!-- Vue Liste (cachée par défaut) -->
	<div id="listView" class="d-none">
		<div class="card">
			<div class="card-body">
				<div class="table-responsive">
					<table id="tasksTable" class="table table-striped table-hover">
						<thead>
							<tr>
								<th>Titre</th>
								<th>Priorité</th>
								<th>Statut</th>
								<th>Assigné à</th>
								<th>Date d'échéance</th>
								<th>Client</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							<!-- Rempli dynamiquement -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Nouvelle Tâche -->
	<div class="modal fade" id="addTaskModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Nouvelle Tâche</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<form id="taskForm">
					<div class="modal-body">
						<div class="row">
							<div class="col-md-4">
								<div class="mb-3">
									<label class="form-label">Titre *</label> <input type="text"
										class="form-control" name="titre" required>
								</div>
							</div>
							<div class="col-md-4">
								<div class="mb-3">
									<label class="form-label">Priorité *</label> <select
										class="form-select" name="statut" required>
										<option value="">Choisir...</option>
										<option th:each="statut : ${statuts}"
											th:text="${statut.name.toLowerCase().replace('_',' ')}"
											th:value="${statut.name}"></option>
									</select>
								</div>
							</div>
							<div class="col-md-4">
								<div class="mb-3">
									<label class="form-label">Priorité *</label> <select
										class="form-select" name="priorite" required>
										<option value="">Choisir...</option>
										<option th:each="priorite : ${priorites}"
											th:text="${priorite.name.toLowerCase()}"
											th:value="${priorite.name}"></option>
									</select>
								</div>
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">Description</label>
							<textarea class="form-control" name="description" rows="3"></textarea>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Date de début</label> <input
										type="datetime-local" class="form-control" name="dateDebut">
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Date d'échéance</label> <input
										type="datetime-local" class="form-control" name="dateEcheance">
								</div>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Assigné à *</label> <select
										class="form-select" name="idUtilisateur" required>
										<option value="">Choisir un utilisateur...</option>
										<!-- Dynamique via API -->
									</select>
								</div>
							</div>
							<div class="col-md-6">
								<div class="mb-3">
									<label class="form-label">Client</label> <select
										class="form-select" name="idClient">
										<option value="">Choisir un client...</option>
										<!-- Dynamique via API -->
									</select>
								</div>
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">Opportunité</label> <select
								class="form-select" name="idOpportunite">
								<option value="">Choisir une opportunité...</option>
								<!-- Dynamique via API -->
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Annuler</button>
						<button type="submit" class="btn btn-primary">Créer la
							tâche</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<div layout:fragment="scripts">
    <!-- jQuery (prérequis pour DataTables) -->
    <!-- Dans votre HTML - AJOUTER CES SCRIPTS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- WebSocket avec fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js" 
            onerror="loadFallbackScript('sockjs', '/js/libs/sockjs.min.js')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"
            onerror="loadFallbackScript('stomp', '/js/libs/stomp.min.js')"></script>

    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fr.min.js'></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- Script principal -->
    <script th:src="@{/ressources/js/taches.js}" defer></script>

    <script>
    // Gestion des erreurs de chargement
    function loadFallbackScript(libName, fallbackUrl) {
        console.warn(libName + ' non chargé depuis CDN, tentative avec fallback');
        var script = document.createElement('script');
        script.src = fallbackUrl;
        document.head.appendChild(script);
    }

    // Vérification que tout est chargé
    window.addEventListener('load', function() {
        const requiredLibs = {
            'SockJS': typeof SockJS,
            'Stomp': typeof Stomp,
            'FullCalendar': typeof FullCalendar,
            'jQuery': typeof jQuery,
            'DataTable': typeof $.fn.DataTable
        };

        for (const [lib, type] of Object.entries(requiredLibs)) {
            if (type === 'undefined') {
                console.error(`${lib} non chargé`);
                // Afficher un message à l'utilisateur
            }
        }
    });
    </script>
</div>
</html>